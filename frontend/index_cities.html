<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–≤–∏—Ç–æ –ü–∞—Ä—Å–µ—Ä v2</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 0; margin-bottom: 30px; }
        h1 { font-size: 1.8rem; font-weight: 700; }
        
        .card { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .card h2 { font-size: 1.2rem; margin-bottom: 15px; color: #667eea; }
        
        .city-card { background: #f8f9fa; border: 2px solid #e0e0e0; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
        .city-card.disabled { opacity: 0.5; }
        
        .city-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .city-name { font-size: 1.2rem; font-weight: 700; color: #333; }
        
        .city-sources { display: grid; gap: 8px; }
        .source-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 8px; }
        
        button { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; }
        button:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        
        .btn-small { padding: 6px 12px; font-size: 0.9rem; }
        .btn-danger { background: #ef4444; }
        .btn-success { background: #10b981; }
        
        .stat-card { background: white; padding: 15px; border-radius: 8px; text-align: center; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .stat-value { font-size: 2rem; font-weight: 700; color: #667eea; }
        
        .stats { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-bottom: 20px; }
        
        input, textarea { width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-family: monospace; }
        input:focus, textarea:focus { outline: none; border-color: #667eea; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 6px; font-weight: 600; color: #555; }
        
        .hint { font-size: 0.85rem; color: #666; margin-top: 4px; }
        
        .alert { padding: 12px 15px; border-radius: 8px; margin-bottom: 15px; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        
        .toggle-switch { display: inline-flex; align-items: center; gap: 8px; }
        .toggle-switch input { width: 40px; height: 24px; accent-color: #667eea; }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <h1>üîç –ê–≤–∏—Ç–æ –ü–∞—Ä—Å–µ—Ä v2</h1>
        </div>
    </header>

    <div class="container">
        <div id="alert" style="display: none;"></div>

        <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="stat-total">0</div>
                <div>–í—Å–µ–≥–æ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-new">0</div>
                <div>–ù–æ–≤—ã–µ</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="stat-published">0</div>
                <div>–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</div>
            </div>
        </div>

        <!-- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div class="card">
                <h2>üì± VK –¢–æ–∫–µ–Ω (–¥–ª—è –≤—Å–µ—Ö)</h2>
                <div class="form-group">
                    <input type="password" id="vk-token" placeholder="vk1.a...">
                </div>
                <div class="form-group">
                    <label>üöó –ê–≤—Ç–æ</label>
                    <input type="text" id="vk-auto" placeholder="-123456">
                </div>
                <div class="form-group">
                    <label>üè† –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</label>
                    <input type="text" id="vk-real" placeholder="-123456">
                </div>
                <button onclick="saveVK()" style="width: 100%;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>

            <div class="card">
                <h2>üí¨ Telegram (–¥–ª—è –≤—Å–µ—Ö)</h2>
                <div class="form-group">
                    <input type="password" id="tg-token" placeholder="123:ABC...">
                </div>
                <div class="form-group">
                    <label>üöó –ê–≤—Ç–æ</label>
                    <input type="text" id="tg-auto" placeholder="@avto">
                </div>
                <div class="form-group">
                    <label>üè† –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å</label>
                    <input type="text" id="tg-real" placeholder="@realty">
                </div>
                <button onclick="saveTelegram()" style="width: 100%;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>

        <!-- –ì–æ—Ä–æ–¥–∞ -->
        <div class="card">
            <h2>üåç –ì–æ—Ä–æ–¥–∞ –∏ —Å—Å—ã–ª–∫–∏</h2>
            
            <!-- –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥ -->
            <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 10px; margin-bottom: 20px;">
                <input type="text" id="new-city-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞ —Ä—É—Å—Å–∫–æ–º)">
                <input type="text" id="new-city-slug" placeholder="–°–ª–∞–≥ (vorkuta)">
            </div>
            <button onclick="addCity()" style="width: 100%; margin-bottom: 20px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥</button>

            <!-- –°–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤ -->
            <div id="cities-list"></div>
        </div>

        <!-- –ü—Ä–æ–∫—Å–∏ –∏ —Å—Ç–æ–ø-—Å–ª–æ–≤–∞ -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <div class="card">
                <h2>üîó –ü—Ä–æ–∫—Å–∏ (–¥–ª—è –≤—Å–µ—Ö)</h2>
                <textarea id="proxies" placeholder="http://ip:port&#10;http://ip:port" style="height: 100px;"></textarea>
                <button onclick="saveProxies()" style="width: 100%; margin-top: 10px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>

            <div class="card">
                <h2>üö´ –°—Ç–æ–ø-—Å–ª–æ–≤–∞ (–¥–ª—è –≤—Å–µ—Ö)</h2>
                <textarea id="stop-words" placeholder="—Ä–∞—Å—Å—Ä–æ—á–∫–∞&#10;–∫—Ä–µ–¥–∏—Ç&#10;—Ñ—Ä–∞–Ω—à–∏–∑–∞" style="height: 100px;"></textarea>
                <button onclick="saveStopWords()" style="width: 100%; margin-top: 10px;">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>

        <!-- –ù–∞–ø–æ–ª–Ω–µ–Ω–∏–µ -->
        <div class="card" style="text-align: center;">
            <h2>üöÄ –ù–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –≥–æ—Ä–æ–¥–∞</h2>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <button onclick="fill(1)" class="btn-success">–î–µ–Ω—å</button>
                <button onclick="fill(3)" class="btn-success">3 –¥–Ω—è</button>
                <button onclick="fill(5)" class="btn-success">5 –¥–Ω–µ–π</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = 'http://151.247.209.203:5000/api';
        let config = {};

        async function loadConfig() {
            try {
                const res = await fetch(`${API_URL}/config`);
                config = await res.json();
                
                document.getElementById('vk-token').value = config.vk?.access_token || '';
                document.getElementById('vk-auto').value = config.vk?.groups?.auto || '';
                document.getElementById('vk-real').value = config.vk?.groups?.real_estate_sale || '';
                
                document.getElementById('tg-token').value = config.telegram?.bot_token || '';
                document.getElementById('tg-auto').value = config.telegram?.channels?.auto || '';
                document.getElementById('tg-real').value = config.telegram?.channels?.real_estate_sale || '';
                
                document.getElementById('proxies').value = (config.proxies || []).join('\n');
                document.getElementById('stop-words').value = (config.stop_words || []).join('\n');
                
                renderCities();
                loadStats();
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        async function addCity() {
            const name = document.getElementById('new-city-name').value.trim();
            const slug = document.getElementById('new-city-slug').value.trim().lower();
            
            if (!name || !slug) {
                showAlert('–ó–∞–ø–æ–ª–Ω–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏ —Å–ª–∞–≥', 'error');
                return;
            }

            try {
                const res = await fetch(`${API_URL}/cities`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, url_slug: slug})
                });
                const data = await res.json();
                
                if (res.ok) {
                    document.getElementById('new-city-name').value = '';
                    document.getElementById('new-city-slug').value = '';
                    await loadConfig();
                    showAlert(`‚úÖ ${data.message}`, 'success');
                } else {
                    showAlert(data.error, 'error');
                }
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        function renderCities() {
            const container = document.getElementById('cities-list');
            const cities = config.cities || [];
            
            if (!cities.length) {
                container.innerHTML = '<p style="color: #999;">–ì–æ—Ä–æ–¥–∞ –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã. –î–æ–±–∞–≤—å –ø–µ—Ä–≤—ã–π –≥–æ—Ä–æ–¥ –≤—ã—à–µ!</p>';
                return;
            }

            container.innerHTML = cities.map((city, idx) => `
                <div class="city-card ${city.enabled ? '' : 'disabled'}">
                    <div class="city-header">
                        <div class="city-name">${city.name}</div>
                        <div style="display: flex; gap: 10px;">
                            <label class="toggle-switch">
                                <input type="checkbox" ${city.enabled ? 'checked' : ''} onchange="toggleCity('${city.url_slug}')">
                                <span>${city.enabled ? '‚úÖ' : '‚ùå'}</span>
                            </label>
                            <button class="btn-small btn-danger" onclick="deleteCity('${city.url_slug}')">üóëÔ∏è</button>
                        </div>
                    </div>

                    <div class="city-sources">
                        ${(city.sources || []).map((src, sidx) => `
                            <div class="source-item">
                                <div style="flex: 1;">
                                    <div style="font-weight: 600;">${src.category}</div>
                                    <div style="font-size: 0.8rem; color: #999;">${src.url_path}</div>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" ${src.enabled ? 'checked' : ''} onchange="toggleSource('${city.url_slug}', ${sidx})">
                                </label>
                            </div>
                        `).join('')}
                    </div>
                    <button class="btn-small" onclick="saveCitySources('${city.url_slug}')" style="width: 100%; margin-top: 10px;">üíæ</button>
                </div>
            `).join('');
        }

        function toggleCity(slug) {
            config.cities.forEach(city => {
                if (city.url_slug === slug) {
                    city.enabled = !city.enabled;
                }
            });
            renderCities();
        }

        function toggleSource(slug, idx) {
            config.cities.forEach(city => {
                if (city.url_slug === slug) {
                    city.sources[idx].enabled = !city.sources[idx].enabled;
                }
            });
            renderCities();
        }

        async function saveCitySources(slug) {
            const city = config.cities.find(c => c.url_slug === slug);
            if (!city) return;

            try {
                await fetch(`${API_URL}/cities/${slug}/sources`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({sources: city.sources})
                });
                showAlert('‚úÖ –°—Å—ã–ª–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        async function deleteCity(slug) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –≥–æ—Ä–æ–¥?')) return;

            try {
                await fetch(`${API_URL}/cities/${slug}`, {method: 'DELETE'});
                await loadConfig();
                showAlert('‚úÖ –ì–æ—Ä–æ–¥ —É–¥–∞–ª–µ–Ω', 'success');
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        async function saveVK() {
            try {
                await fetch(`${API_URL}/tokens/vk`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        access_token: document.getElementById('vk-token').value,
                        groups: {
                            auto: document.getElementById('vk-auto').value,
                            real_estate_sale: document.getElementById('vk-real').value,
                        }
                    })
                });
                showAlert('‚úÖ VK —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        async function saveTelegram() {
            try {
                await fetch(`${API_URL}/tokens/telegram`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        bot_token: document.getElementById('tg-token').value,
                        channels: {
                            auto: document.getElementById('tg-auto').value,
                            real_estate_sale: document.getElementById('tg-real').value,
                        }
                    })
                });
                showAlert('‚úÖ Telegram —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        async function saveProxies() {
            const proxies = document.getElementById('proxies').value.split('\n').filter(p => p.trim());
            try {
                await fetch(`${API_URL}/proxies`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({proxies})
                });
                showAlert(`‚úÖ –ü—Ä–æ–∫—Å–∏: ${proxies.length} —à—Ç.`, 'success');
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        async function saveStopWords() {
            const words = document.getElementById('stop-words').value.split('\n').filter(w => w.trim());
            try {
                await fetch(`${API_URL}/stop-words`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({stop_words: words})
                });
                showAlert(`‚úÖ –°—Ç–æ–ø-—Å–ª–æ–≤–∞: ${words.length} —à—Ç.`, 'success');
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        async function fill(days) {
            if (!confirm(`–ù–∞–ø–æ–ª–Ω–∏—Ç—å –∑–∞ ${days} –¥–Ω–µ–π?`)) return;
            try {
                showAlert(`üîÑ –ó–∞–ø—É—â–µ–Ω–æ...`, 'success');
                await fetch(`${API_URL}/fill-groups`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({days})
                });
                setInterval(loadStats, 5000);
            } catch (e) {
                showAlert('–û—à–∏–±–∫–∞: ' + e.message, 'error');
            }
        }

        async function loadStats() {
            try {
                const res = await fetch(`${API_URL}/stats`);
                const stats = await res.json();
                document.getElementById('stat-total').textContent = stats.total;
                document.getElementById('stat-new').textContent = stats.new;
                document.getElementById('stat-published').textContent = stats.published;
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞:', e);
            }
        }

        function showAlert(msg, type) {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type}`;
            alert.textContent = msg;
            alert.style.display = 'block';
            setTimeout(() => { alert.style.display = 'none'; }, 4000);
        }

        loadConfig();
        setInterval(loadStats, 10000);
    </script>
</body>
</html>
